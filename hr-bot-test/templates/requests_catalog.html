
{% extends "base.html" %}

{% block title %}–ö–∞—Ç–∞–ª–æ–≥ –∑–∞—è–≤–æ–∫ - SapaHR{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìù –®–∞–±–ª–æ–Ω—ã –∑–∞—è–≤–æ–∫</h1>
</div>

<div class="tabs">
    <button class="tab active" onclick="switchTab('templates')">–®–∞–±–ª–æ–Ω—ã</button>
    <button class="tab" onclick="switchTab('files')">–§–∞–π–ª—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</button>
    <button class="tab" onclick="switchTab('my')">–ú–æ–∏ –∑–∞—è–≤–∫–∏</button>
</div>

<!-- –®–∞–±–ª–æ–Ω—ã –∑–∞—è–≤–æ–∫ -->
<div id="templates-tab" class="tab-content active">
    {% if is_admin or session.get('role') == 'moderator' %}
    <div class="card mb-3">
        <button class="btn btn-primary" onclick="toggleAddTemplateModal()">+ –î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
    </div>
    {% endif %}
    
    <div class="templates-grid">
        {% for template in templates %}
        <div class="template-card" style="border-left: 4px solid {{ template.color }}">
            <div class="template-header">
                <div class="template-icon" style="background: {{ template.color }}">{{ template.icon }}</div>
                <div class="template-info">
                    <h3>{{ template.title }}</h3>
                    <p>{{ template.description }}</p>
                    <span class="company-badge">{{ template.company }}</span>
                </div>
            </div>
            <div class="template-files">
                {% if template.id in files_by_template %}
                    <h4>–§–∞–π–ª—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:</h4>
                    <ul class="file-list">
                        {% for file in files_by_template[template.id] %}
                        <li>
                            <a href="{{ file.file_url }}" target="_blank" class="file-link">
                                üìÑ {{ file.filename or file.original_name or '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}
                            </a>
                            {% if is_admin or session.get('role') == 'moderator' %}
                            <form method="POST" action="{{ url_for('delete_file', file_id=file.id) }}" style="display: inline;">
                                <button type="submit" class="btn-icon-delete" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?')">üóëÔ∏è</button>
                            </form>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
            <div class="template-actions">
                {% if is_admin or session.get('role') == 'moderator' %}
                <button class="btn btn-sm" onclick="showUploadModal({{ template.id }}, '{{ template.company }}')">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</button>
                <form method="POST" action="{{ url_for('delete_template', template_id=template.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?')">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- –í—Å–µ —Ñ–∞–π–ª—ã -->
<div id="files-tab" class="tab-content">
    {% if is_admin or session.get('role') == 'moderator' %}
    <div class="card mb-3">
        <button class="btn btn-primary" onclick="showUploadModal(null, '{{ user_company }}')">+ –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</button>
    </div>
    {% endif %}
    
    <div class="files-grid">
        {% for file in files_by_template.get('general', []) %}
        <div class="file-card">
            <div class="file-icon">üìÑ</div>
            <div class="file-info">
                <h4>{{ file.filename or file.original_name or '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}</h4>
                <p>{{ file.company }}</p>
                <small>–î–æ–±–∞–≤–ª–µ–Ω: {{ file.created_at.strftime('%d.%m.%Y') if file.created_at else '–ù–µ–¥–∞–≤–Ω–æ' }}</small>
            </div>
            <div class="file-actions">
                <a href="{{ file.file_url }}" target="_blank" class="btn btn-sm">–û—Ç–∫—Ä—ã—Ç—å</a>
                {% if is_admin or session.get('role') == 'moderator' %}
                <form method="POST" action="{{ url_for('delete_file', file_id=file.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?')">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- –ú–æ–∏ –∑–∞—è–≤–∫–∏ -->
<div id="my-tab" class="tab-content">
    <div class="card">
        <table class="data-table">
            <thead>
                <tr>
                    <th>–ó–∞—è–≤–∫–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for req in my_requests %}
                <tr>
                    <td>{{ req.title }}</td>
                    <td><span class="status-badge status-{{ req.status }}">{{ req.status }}</span></td>
                    <td>{{ req.created_at.strftime('%d.%m.%Y') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞ -->
<div id="addTemplateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω –∑–∞—è–≤–∫–∏</h2>
            <button class="close-btn" onclick="toggleAddTemplateModal()">√ó</button>
        </div>
        <form method="POST" action="{{ url_for('add_template') }}">
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" name="title" required>
            </div>
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea name="description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>–ö–æ–º–ø–∞–Ω–∏—è</label>
                <select name="company" required>
                    {% if is_admin %}
                        {% for company in companies %}
                        <option value="{{ company }}">{{ company }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="{{ user_company }}">{{ user_company }}</option>
                    {% endif %}
                </select>
            </div>
            <div class="form-group">
                <label>–ò–∫–æ–Ω–∫–∞</label>
                <input type="text" name="icon" value="üìù">
            </div>
            <div class="form-group">
                <label>–¶–≤–µ—Ç (hex)</label>
                <input type="color" name="color" value="#E8F5E9">
            </div>
            <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª -->
<div id="uploadFileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª</h2>
            <button class="close-btn" onclick="closeUploadModal()">√ó</button>
        </div>
        <form method="POST" action="{{ url_for('add_file_link') }}">
            <input type="hidden" name="template_id" id="upload_template_id">
            <input type="hidden" name="company" id="upload_company">
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞</label>
                <input type="text" name="file_name" required placeholder="–ó–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ—Ç–ø—É—Å–∫">
            </div>
            <div class="form-group">
                <label>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª</label>
                <input type="url" name="file_url" required placeholder="https://drive.google.com/file/...">
                <small>–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ Google Drive, Dropbox –∏–ª–∏ –¥—Ä—É–≥–æ–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</small>
            </div>
            <div class="form-group">
                <label>–¢–∏–ø —Ñ–∞–π–ª–∞</label>
                <select name="file_type">
                    <option value="pdf">PDF</option>
                    <option value="doc">DOC/DOCX</option>
                    <option value="xls">XLS/XLSX</option>
                    <option value="txt">TXT</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
    </div>
</div>

<style>
.templates-grid {
    display: grid;
    gap: 20px;
    margin-top: 20px;
}

.template-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.template-header {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
}

.template-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
}

.template-info h3 {
    margin: 0 0 8px 0;
    font-size: 1.2rem;
}

.template-info p {
    margin: 0 0 8px 0;
    color: #666;
}

.company-badge {
    display: inline-block;
    padding: 4px 12px;
    background: #e3f2fd;
    color: #1976d2;
    border-radius: 16px;
    font-size: 0.85rem;
}

.template-files {
    margin: 16px 0;
}

.file-list {
    list-style: none;
    padding: 0;
}

.file-list li {
    padding: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #f0f0f0;
}

.file-link {
    text-decoration: none;
    color: #1976d2;
}

.template-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
}

.btn-icon-delete {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
}

.files-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.file-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.file-icon {
    font-size: 48px;
    text-align: center;
    margin-bottom: 12px;
}

.file-info h4 {
    margin: 0 0 8px 0;
}

.file-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
}
</style>

<script>
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab + '-tab').classList.add('active');
}

function toggleAddTemplateModal() {
    document.getElementById('addTemplateModal').classList.toggle('active');
}

function showUploadModal(templateId, company) {
    document.getElementById('upload_template_id').value = templateId || '';
    document.getElementById('upload_company').value = company;
    document.getElementById('uploadFileModal').classList.add('active');
}

function closeUploadModal() {
    document.getElementById('uploadFileModal').classList.remove('active');
}
</script>
{% endblock %}
